trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main

variables:
  containerRegistry: 'myacr.azurecr.io'
  imageRepository: 'nodejs-app'
  dockerfilePath: 'Dockerfile'
  tag: '$(Build.BuildId)'
  kubernetesNamespace: 'production'
  containerRegistryServiceConnection: 'acr-service-connection'
  kubernetesServiceConnection: 'aks-service-connection'

stages:
  - stage: Build
    displayName: 'Build and Test'
    jobs:
      - job: BuildTest
        displayName: 'Build, Test, and Lint'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js 20'
            inputs:
              versionSpec: '20.x'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm run lint
            displayName: 'Run linter'

          - script: npm test -- --coverage --reporters=default --reporters=jest-junit
            displayName: 'Run tests with coverage'
            env:
              CI: 'true'

          - task: PublishTestResults@2
            displayName: 'Publish test results'
            condition: succeededOrFailed()
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/junit.xml'
              mergeTestResults: true

          - task: PublishCodeCoverageResults@2
            displayName: 'Publish code coverage report'
            condition: succeededOrFailed()
            inputs:
              codeCoverageTool: 'Cobertura'
              summaryFileLocation: '$(System.DefaultWorkingDirectory)/coverage/cobertura-coverage.xml'

          - script: npm run build
            displayName: 'Build application'

          - task: PublishPipelineArtifact@1
            displayName: 'Publish build artifact'
            inputs:
              targetPath: '$(System.DefaultWorkingDirectory)/dist'
              artifact: 'build-output'

  - stage: SecurityScan
    displayName: 'Security Scan'
    dependsOn: Build
    jobs:
      - job: SecurityScan
        displayName: 'Dependency and Container Security Scan'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: NodeTool@0
            displayName: 'Use Node.js 20'
            inputs:
              versionSpec: '20.x'

          - script: npm ci
            displayName: 'Install dependencies'

          - script: npm audit --audit-level=high
            displayName: 'npm audit - dependency vulnerability scan'

          - task: Docker@2
            displayName: 'Build Docker image for scanning'
            inputs:
              containerRegistry: '$(containerRegistryServiceConnection)'
              repository: '$(imageRepository)'
              command: 'build'
              dockerfile: '$(dockerfilePath)'
              tags: '$(tag)'

          - script: |
              curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin
              trivy image --exit-code 1 --severity HIGH,CRITICAL $(containerRegistry)/$(imageRepository):$(tag)
            displayName: 'Trivy container image vulnerability scan'

  - stage: BuildAndPush
    displayName: 'Build and Push Image'
    dependsOn: SecurityScan
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - job: BuildAndPush
        displayName: 'Build and push image to registry'
        pool:
          vmImage: ubuntu-latest
        steps:
          - task: Docker@2
            displayName: 'Build and push image'
            inputs:
              containerRegistry: '$(containerRegistryServiceConnection)'
              repository: '$(imageRepository)'
              command: 'buildAndPush'
              dockerfile: '$(dockerfilePath)'
              tags: |
                $(tag)
                latest

  - stage: Deploy
    displayName: 'Deploy to Kubernetes'
    dependsOn: BuildAndPush
    condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
    jobs:
      - deployment: DeployToKubernetes
        displayName: 'Deploy to AKS'
        pool:
          vmImage: ubuntu-latest
        environment: 'production'
        strategy:
          runOnce:
            deploy:
              steps:
                - checkout: self

                - task: KubernetesManifest@1
                  displayName: 'Deploy to Kubernetes'
                  inputs:
                    action: 'deploy'
                    kubernetesServiceConnection: '$(kubernetesServiceConnection)'
                    namespace: '$(kubernetesNamespace)'
                    manifests: |
                      k8s/deployment.yml
                      k8s/service.yml
                      k8s/hpa.yml
                    containers: '$(containerRegistry)/$(imageRepository):$(tag)'
